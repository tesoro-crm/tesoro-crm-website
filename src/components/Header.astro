---
import { Image } from 'astro:assets';
import Button from './ui/Button.astro';
import AISearch from './AISearch.astro';
import { getLocale, getLocalizedPath, loadTranslations, t } from '../i18n/utils';
import { languages, languageFlags } from '../i18n/config';
import type { Language } from '../i18n/config';
import logo from '../assets/tesoro-logo-full-color-rgb-1500px-w-300ppi.png';

const currentPath = Astro.url.pathname;
const locale: Language = getLocale(Astro.currentLocale, Astro.url);
await loadTranslations(locale);

// Get base path without language prefix
const basePath = currentPath.replace(/^\/(en|es|nl)/, '') || '/';
---

<header class="sticky top-0 z-[100] bg-white border-b border-neutral-200">
  <nav class="container mx-auto px-4 sm:px-6 lg:px-8 max-w-7xl">
    <div class="flex items-center justify-between h-16 gap-8">
      <!-- Logo -->
      <a href={getLocalizedPath('/', locale)} class="flex items-center hover:opacity-80 transition-opacity flex-shrink-0">
        <Image
          src={logo}
          alt="Tesoro CRM"
          class="h-8 w-auto"
          width={262}
          height={64}
          format="webp"
          quality={85}
          loading="eager"
          fetchpriority="high"
        />
      </a>

      <!-- Desktop Navigation -->
      <ul class="hidden lg:flex items-center gap-6">
        <li class="relative group">
          <button
            class={`flex items-center gap-1 text-sm font-medium transition-colors py-1 ${currentPath === '/features' || currentPath === `/${locale}/features` ? 'text-primary' : 'text-neutral-700 hover:text-primary'}`}
          >
            {t('nav.features', locale)}
            <svg class="w-4 h-4 transition-transform group-hover:rotate-180" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
            </svg>
          </button>

          <!-- Mega Menu - Features -->
          <div class="hidden group-hover:block absolute left-0 top-full pt-2 z-50" style="width: 100vw; margin-left: calc(-50vw + 50%);">
            <div class="bg-white shadow-xl border-t border-neutral-200">
              <div class="mx-auto px-10 py-10" style="max-width: 1200px; width: 1120px;">
                <div class="grid grid-cols-4" style="grid-template-columns: 265px 265px 265px 265px; column-gap: 20px;">
                <!-- Column 1 - Core Features -->
                <div>
                  <h3 class="text-sm font-bold text-neutral-900 mb-2">
                    {locale === 'nl' ? 'Kernfuncties' : locale === 'es' ? 'Funciones Principales' : 'Core Features'}
                  </h3>
                  <p class="text-sm text-neutral-600 mb-3">
                    {locale === 'nl' ? 'Ontdek de krachtige functies van Tesoro.' : locale === 'es' ? 'Descubre las potentes funciones de Tesoro.' : 'Discover Tesoro\'s powerful features.'}
                  </p>
                  <a href={getLocalizedPath('/features', locale)} class="text-sm text-primary hover:underline mb-4 inline-block">
                    {locale === 'nl' ? 'Alle functies bekijken →' : locale === 'es' ? 'Ver todas las funciones →' : 'View all features →'}
                  </a>
                  <div class="space-y-2">
                    <a href={getLocalizedPath('/features/smart-matching', locale)} class="flex items-start gap-2 group/item">
                      <svg class="w-4 h-4 text-neutral-400 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                      </svg>
                      <span class="text-sm text-neutral-700 group-hover/item:text-primary">
                        {locale === 'nl' ? 'Slimme Matching' : locale === 'es' ? 'Coincidencia Inteligente' : 'Smart Matching'}
                      </span>
                    </a>
                    <a href={getLocalizedPath('/features/customer-portal', locale)} class="flex items-start gap-2 group/item">
                      <svg class="w-4 h-4 text-neutral-400 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                      </svg>
                      <span class="text-sm text-neutral-700 group-hover/item:text-primary">
                        {locale === 'nl' ? 'Klanten Portal' : locale === 'es' ? 'Portal de Clientes' : 'Customer Portal'}
                      </span>
                    </a>
                    <a href={getLocalizedPath('/features/deal-pipeline', locale)} class="flex items-start gap-2 group/item">
                      <svg class="w-4 h-4 text-neutral-400 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                      </svg>
                      <span class="text-sm text-neutral-700 group-hover/item:text-primary">
                        {locale === 'nl' ? 'Deal Pipeline' : locale === 'es' ? 'Pipeline de Ventas' : 'Deal Pipeline'}
                      </span>
                    </a>
                  </div>
                </div>

                <!-- Column 2 - Real Estate Tools -->
                <div>
                  <h3 class="text-sm font-bold text-neutral-900 mb-2">
                    {locale === 'nl' ? 'Voor Makelaars' : locale === 'es' ? 'Para Agentes' : 'For Real Estate'}
                  </h3>
                  <p class="text-sm text-neutral-600 mb-3">
                    {locale === 'nl' ? 'Tools voor vastgoedprofessionals.' : locale === 'es' ? 'Herramientas para profesionales inmobiliarios.' : 'Tools built for real estate professionals.'}
                  </p>
                  <div class="space-y-2">
                    <a href={getLocalizedPath('/features/property-management', locale)} class="flex items-start gap-2 group/item">
                      <svg class="w-4 h-4 text-neutral-400 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                      </svg>
                      <span class="text-sm text-neutral-700 group-hover/item:text-primary">
                        {locale === 'nl' ? 'Property Management' : locale === 'es' ? 'Gestión de Propiedades' : 'Property Management'}
                      </span>
                    </a>
                    <a href={getLocalizedPath('/features/email-integration', locale)} class="flex items-start gap-2 group/item">
                      <svg class="w-4 h-4 text-neutral-400 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                      </svg>
                      <span class="text-sm text-neutral-700 group-hover/item:text-primary">
                        {locale === 'nl' ? 'E-mail Integratie' : locale === 'es' ? 'Integración Email' : 'Email Integration'}
                      </span>
                    </a>
                    <a href={getLocalizedPath('/features/reporting-analytics', locale)} class="flex items-start gap-2 group/item">
                      <svg class="w-4 h-4 text-neutral-400 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                      </svg>
                      <span class="text-sm text-neutral-700 group-hover/item:text-primary">
                        {locale === 'nl' ? 'Rapportages & Analytics' : locale === 'es' ? 'Reportes y Analíticas' : 'Reporting & Analytics'}
                      </span>
                    </a>
                  </div>
                </div>

                <!-- Column 3 - Automation -->
                <div>
                  <h3 class="text-sm font-bold text-neutral-900 mb-2">
                    {locale === 'nl' ? 'Automatisering' : locale === 'es' ? 'Automatización' : 'Automation'}
                  </h3>
                  <p class="text-sm text-neutral-600 mb-3">
                    {locale === 'nl' ? 'Bespaar tijd met automatisering.' : locale === 'es' ? 'Ahorra tiempo con automatización.' : 'Save time with automation.'}
                  </p>
                  <div class="space-y-2">
                    <a href={getLocalizedPath('/features#workflow-automation', locale)} class="flex items-start gap-2 group/item">
                      <svg class="w-4 h-4 text-neutral-400 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                      </svg>
                      <span class="text-sm text-neutral-700 group-hover/item:text-primary">
                        {locale === 'nl' ? 'Workflow Automatisering' : locale === 'es' ? 'Automatización de Flujos' : 'Workflow Automation'}
                      </span>
                    </a>
                    <a href={getLocalizedPath('/features#email-campaigns', locale)} class="flex items-start gap-2 group/item">
                      <svg class="w-4 h-4 text-neutral-400 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                      </svg>
                      <span class="text-sm text-neutral-700 group-hover/item:text-primary">
                        {locale === 'nl' ? 'Email Campagnes' : locale === 'es' ? 'Campañas Email' : 'Email Campaigns'}
                      </span>
                    </a>
                    <a href={getLocalizedPath('/features#xml-feeds', locale)} class="flex items-start gap-2 group/item">
                      <svg class="w-4 h-4 text-neutral-400 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                      </svg>
                      <span class="text-sm text-neutral-700 group-hover/item:text-primary">
                        {locale === 'nl' ? 'XML Feed Sync' : locale === 'es' ? 'Sincronización XML' : 'XML Feed Sync'}
                      </span>
                    </a>
                  </div>
                </div>

                <!-- Column 4 - Integrations -->
                <div>
                  <h3 class="text-sm font-bold text-neutral-900 mb-2">
                    {locale === 'nl' ? 'Integraties' : locale === 'es' ? 'Integraciones' : 'Integrations'}
                  </h3>
                  <p class="text-sm text-neutral-600 mb-3">
                    {locale === 'nl' ? 'Verbind met je favoriete tools.' : locale === 'es' ? 'Conecta con tus herramientas favoritas.' : 'Connect with your favorite tools.'}
                  </p>
                  <div class="space-y-2">
                    <a href={getLocalizedPath('/integrations#email', locale)} class="flex items-start gap-2 group/item">
                      <svg class="w-4 h-4 text-neutral-400 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                      </svg>
                      <span class="text-sm text-neutral-700 group-hover/item:text-primary">
                        {locale === 'nl' ? 'Email Providers' : locale === 'es' ? 'Proveedores Email' : 'Email Providers'}
                      </span>
                    </a>
                    <a href={getLocalizedPath('/integrations#calendar', locale)} class="flex items-start gap-2 group/item">
                      <svg class="w-4 h-4 text-neutral-400 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                      </svg>
                      <span class="text-sm text-neutral-700 group-hover/item:text-primary">
                        {locale === 'nl' ? 'Agenda Apps' : locale === 'es' ? 'Apps de Calendario' : 'Calendar Apps'}
                      </span>
                    </a>
                    <a href={getLocalizedPath('/integrations#portals', locale)} class="flex items-start gap-2 group/item">
                      <svg class="w-4 h-4 text-neutral-400 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                      </svg>
                      <span class="text-sm text-neutral-700 group-hover/item:text-primary">
                        {locale === 'nl' ? 'Woningportals' : locale === 'es' ? 'Portales Inmobiliarios' : 'Property Portals'}
                      </span>
                    </a>
                  </div>
                </div>
              </div>
              </div>
            </div>
          </div>
        </li>

        <li>
          <a
            href={getLocalizedPath('/pricing', locale)}
            class={`text-sm font-medium transition-colors py-1 ${currentPath === '/pricing' || currentPath === `/${locale}/pricing` ? 'text-primary' : 'text-neutral-700 hover:text-primary'}`}
          >
            {t('nav.pricing', locale)}
          </a>
        </li>
        <li>
          <a
            href={getLocalizedPath('/knowledge-base', locale)}
            class={`text-sm font-medium transition-colors py-1 ${currentPath.startsWith('/knowledge-base') || currentPath.startsWith(`/${locale}/knowledge-base`) ? 'text-primary' : 'text-neutral-700 hover:text-primary'}`}
          >
            {locale === 'nl' ? 'Kennisbank' : locale === 'es' ? 'Base de Conocimientos' : 'Knowledge Base'}
          </a>
        </li>
        <li>
          <a
            href={getLocalizedPath('/blog', locale)}
            class={`text-sm font-medium transition-colors py-1 ${currentPath.startsWith('/blog') || currentPath.startsWith(`/${locale}/blog`) ? 'text-primary' : 'text-neutral-700 hover:text-primary'}`}
          >
            Blog
          </a>
        </li>
      </ul>

      <!-- Right Side Actions -->
      <div class="hidden lg:flex items-center gap-4">
        <!-- Search Icon -->
        <button
          class="p-2 text-neutral-700 hover:text-primary transition-colors"
          aria-label="Search"
          id="search-button"
        >
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
          </svg>
        </button>

        <!-- Language Selector -->
        <div class="relative">
          <button
            id="language-button"
            class="flex items-center gap-1 p-2 text-neutral-700 hover:text-primary transition-colors"
            aria-label="Select language"
          >
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3.055 11H5a2 2 0 012 2v1a2 2 0 002 2 2 2 0 012 2v2.945M8 3.935V5.5A2.5 2.5 0 0010.5 8h.5a2 2 0 012 2 2 2 0 104 0 2 2 0 012-2h1.064M15 20.488V18a2 2 0 012-2h3.064M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
            </svg>
            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
            </svg>
          </button>
          <div
            id="language-menu"
            class="hidden absolute right-0 mt-2 w-40 bg-white rounded-lg shadow-lg border border-neutral-200 py-1 z-50"
          >
            {Object.entries(languages).map(([lang, name]) => (
              <a
                href={getLocalizedPath(basePath, lang as Language)}
                class={`block px-4 py-2 text-sm hover:bg-neutral-50 ${locale === lang ? 'text-primary font-semibold' : 'text-neutral-700'}`}
              >
                {languageFlags[lang as Language]} {name}
              </a>
            ))}
          </div>
        </div>

        <!-- Login Link -->
        <a
          href={getLocalizedPath('/login', locale)}
          class="text-sm font-medium text-neutral-700 hover:text-primary transition-colors"
        >
          {locale === 'nl' ? 'Aanmelden' : locale === 'es' ? 'Iniciar sesión' : 'Login'}
        </a>

        <!-- CTA Button -->
        <Button variant="primary" size="sm" href={getLocalizedPath('/signup', locale)}>
          {t('nav.cta', locale)}
        </Button>
      </div>

      <!-- Mobile Menu Button -->
      <button
        class="lg:hidden p-2 text-neutral-700 hover:text-primary"
        aria-label="Menu"
        id="mobile-menu-button"
      >
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/>
        </svg>
      </button>
    </div>

    <!-- Mobile Menu -->
    <div class="hidden lg:hidden pb-4" id="mobile-menu">
      <ul class="space-y-2">
        <li>
          <a href={getLocalizedPath('/features', locale)} class="block py-2 text-neutral-700 hover:text-primary">
            {t('nav.features', locale)}
          </a>
        </li>
        <li>
          <a href={getLocalizedPath('/knowledge-base', locale)} class="block py-2 text-neutral-700 hover:text-primary">
            {locale === 'nl' ? 'Kennisbank' : locale === 'es' ? 'Base de Conocimientos' : 'Knowledge Base'}
          </a>
        </li>
        <li>
          <a href={getLocalizedPath('/blog', locale)} class="block py-2 text-neutral-700 hover:text-primary">
            Blog
          </a>
        </li>
        <li>
          <a href={getLocalizedPath('/pricing', locale)} class="block py-2 text-neutral-700 hover:text-primary">
            {t('nav.pricing', locale)}
          </a>
        </li>
        <li class="border-t border-neutral-200 pt-2 mt-2">
          <p class="text-xs text-neutral-700 mb-2 px-2">{t('nav.language', locale)}</p>
          {Object.entries(languages).map(([lang, name]) => (
            <a 
              href={getLocalizedPath(basePath, lang as Language)} 
              class={`block py-2 px-2 text-sm rounded ${locale === lang ? 'bg-primary/10 text-primary font-semibold' : 'text-neutral-700 hover:bg-neutral-50'}`}
            >
              {languageFlags[lang as Language]} {name}
            </a>
          ))}
        </li>
        <li class="pt-2">
          <Button variant="primary" size="sm" href={getLocalizedPath('/signup', locale)} fullWidth>
            {t('nav.cta', locale)}
          </Button>
        </li>
      </ul>
    </div>
  </nav>
</header>

<script>
  function initHeader() {
    // Mobile menu toggle
    const mobileButton = document.getElementById('mobile-menu-button');
    const mobileMenu = document.getElementById('mobile-menu');

    if (mobileButton && mobileMenu) {
      mobileButton.addEventListener('click', () => {
        mobileMenu.classList.toggle('hidden');
      });
    }

    // Search button - placeholder for future search functionality
    const searchButton = document.getElementById('search-button');
    if (searchButton) {
      searchButton.addEventListener('click', () => {
        // TODO: Implement search modal/functionality
        console.log('Search clicked - implement search functionality');
      });
    }

    // Language selector toggle
    const languageButton = document.getElementById('language-button');
    const languageMenu = document.getElementById('language-menu');

    if (languageButton && languageMenu) {
      languageButton.addEventListener('click', (e) => {
        e.stopPropagation();
        languageMenu.classList.toggle('hidden');
      });

      // Close language menu when clicking outside
      document.addEventListener('click', (e) => {
        const target = e.target as HTMLElement;
        if (!languageButton.contains(target) && !languageMenu.contains(target)) {
          languageMenu.classList.add('hidden');
        }
      });

      // Language persistence - save preference when language link is clicked
      languageMenu.querySelectorAll('a').forEach((link) => {
        link.addEventListener('click', (e) => {
          const href = (e.currentTarget as HTMLAnchorElement).getAttribute('href');
          if (href) {
            // Extract language from href (/, /en, /es)
            const lang = href.startsWith('/en') ? 'en' : href.startsWith('/es') ? 'es' : 'nl';
            // Save to cookie (expires in 1 year)
            document.cookie = `preferred-language=${lang}; path=/; max-age=31536000; SameSite=Lax`;
            // Also save to localStorage as backup
            localStorage.setItem('preferred-language', lang);
          }
        });
      });
    }
  }

  // Run on initial load
  initHeader();

  // Re-run after View Transitions
  document.addEventListener('astro:after-swap', initHeader);
</script>
