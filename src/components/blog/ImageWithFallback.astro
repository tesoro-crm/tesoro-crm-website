---
/**
 * Image component with automatic fallback to placeholder
 * Maintains aspect ratio and prevents layout shift
 */

interface Props {
  src: string;
  alt: string;
  width?: number;
  height?: number;
  loading?: 'eager' | 'lazy';
  class?: string;
  aspectRatio?: string; // e.g., "16/9", "4/3", "1/1"
  clickable?: boolean; // Enable/disable modal zoom (default: true)
}

const {
  src,
  alt,
  width = 1200,
  height = 600,
  loading = 'lazy',
  class: className = '',
  aspectRatio,
  clickable = true,
} = Astro.props;

// Calculate aspect ratio
const calculatedAspectRatio = aspectRatio || `${width}/${height}`;

// Generate a unique ID for this image
const imageId = `img-${Math.random().toString(36).substr(2, 9)}`;
const modalId = `modal-${imageId}`;

// Extract category/theme from alt text for color scheme
const getThemeColor = (altText: string): string => {
  const text = altText.toLowerCase();
  if (text.includes('crm') || text.includes('software')) return '#4BA3FF';
  if (text.includes('vastgoed') || text.includes('real estate') || text.includes('makelaar')) return '#10B981';
  if (text.includes('automatisering') || text.includes('automation') || text.includes('ai')) return '#F59E0B';
  if (text.includes('data') || text.includes('analytics')) return '#8B5CF6';
  return '#0f172a'; // default
};

const themeColor = getThemeColor(alt);
---

<div class="image-with-fallback" style={`aspect-ratio: ${calculatedAspectRatio};`}>
  {clickable ? (
    <button 
      class="image-with-fallback__button"
      onclick={`document.getElementById('${modalId}').style.display='flex'`}
      aria-label="Klik om afbeelding te vergroten"
    >
      <img
        id={imageId}
        class={`image-with-fallback__img ${className}`}
        src={src}
        alt={alt}
        width={width}
        height={height}
        loading={loading}
        onload={`document.getElementById('${imageId}').classList.add('loaded'); document.getElementById('${imageId}-fallback').style.display='none';`}
        onerror={`document.getElementById('${imageId}').style.display='none'; document.getElementById('${imageId}-fallback').style.display='flex';`}
      />
      <div class="image-with-fallback__expand-hint">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M15 3h6v6M9 21H3v-6M21 3l-7 7M3 21l7-7"></path>
        </svg>
      </div>
    </button>
  ) : (
    <div class="image-with-fallback__wrapper">
      <img
        id={imageId}
        class={`image-with-fallback__img ${className}`}
        src={src}
        alt={alt}
        width={width}
        height={height}
        loading={loading}
        onload={`document.getElementById('${imageId}').classList.add('loaded'); document.getElementById('${imageId}-fallback').style.display='none';`}
        onerror={`document.getElementById('${imageId}').style.display='none'; document.getElementById('${imageId}-fallback').style.display='flex';`}
      />
    </div>
  )}
  <div id={`${imageId}-fallback`} class="image-with-fallback__placeholder" style={`background: linear-gradient(135deg, ${themeColor}15 0%, ${themeColor}05 100%); display: none;`}>
    <div class="image-with-fallback__placeholder-content">
      <svg class="image-with-fallback__icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
        <circle cx="8.5" cy="8.5" r="1.5"></circle>
        <polyline points="21 15 16 10 5 21"></polyline>
      </svg>
      <p class="image-with-fallback__text">{alt}</p>
    </div>
  </div>
</div>

{clickable && (<>
  <div id={modalId} class="image-modal" onclick={`if(event.target.id==='${modalId}')document.getElementById('${modalId}').style.display='none'`}>
    <button class="image-modal__close" onclick={`document.getElementById('${modalId}').style.display='none'`} aria-label="Sluiten">
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <line x1="18" y1="6" x2="6" y2="18"></line>
        <line x1="6" y1="6" x2="18" y2="18"></line>
      </svg>
    </button>
    <img src={src} alt={alt} class="image-modal__img" />
  </div>
</>)}

<script>
  // Check all images on page load
  document.addEventListener('DOMContentLoaded', () => {
    const images = document.querySelectorAll<HTMLImageElement>('.image-with-fallback__img');
    images.forEach(img => {
      // If image fails to load or is already broken
      if (!img.complete || img.naturalWidth === 0) {
        const fallback = document.getElementById(img.id + '-fallback');
        if (fallback) {
          img.style.display = 'none';
          fallback.style.display = 'flex';
        }
      }
    });
  });
</script>

<style>
  .image-with-fallback {
    position: relative;
    overflow: hidden;
    background: #f1f5f9;
    border-radius: 12px;
    display: block;
    width: 100%;
    max-height: 500px;
  }

  .image-with-fallback__button,
  .image-with-fallback__wrapper {
    width: 100%;
    height: 100%;
    border: none;
    padding: 0;
    background: none;
    position: relative;
    display: block;
  }

  .image-with-fallback__button {
    cursor: zoom-in;
  }

  .image-with-fallback__button:hover .image-with-fallback__expand-hint {
    opacity: 1;
  }

  .image-with-fallback__expand-hint {
    position: absolute;
    bottom: 12px;
    right: 12px;
    background: rgba(15, 23, 42, 0.8);
    color: white;
    padding: 8px;
    border-radius: 6px;
    opacity: 0;
    transition: opacity 0.2s ease;
    pointer-events: none;
    backdrop-filter: blur(4px);
  }

  .image-with-fallback__img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: block;
    opacity: 0;
    transition: opacity 0.3s ease;
  }

  .image-with-fallback__img.loaded {
    opacity: 1;
  }

  /* Modal styles */
  .image-modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.9);
    z-index: 9999;
    align-items: center;
    justify-content: center;
    padding: 2rem;
    cursor: zoom-out;
  }

  .image-modal__close {
    position: absolute;
    top: 1rem;
    right: 1rem;
    background: rgba(255, 255, 255, 0.1);
    border: none;
    color: white;
    width: 40px;
    height: 40px;
    border-radius: 50%;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: background 0.2s ease;
    backdrop-filter: blur(4px);
  }

  .image-modal__close:hover {
    background: rgba(255, 255, 255, 0.2);
  }

  .image-modal__img {
    max-width: 90%;
    max-height: 90vh;
    object-fit: contain;
    border-radius: 8px;
    cursor: default;
  }

  .image-with-fallback__placeholder {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    width: 100%;
    height: 100%;
    display: none;
    align-items: center;
    justify-content: center;
    border: 2px dashed #cbd5e1;
    border-radius: 12px;
    box-sizing: border-box;
  }

  .image-with-fallback__placeholder-content {
    text-align: center;
    padding: 2rem;
    max-width: 80%;
  }

  .image-with-fallback__icon {
    width: 64px;
    height: 64px;
    margin: 0 auto 1rem;
    color: #64748b;
    opacity: 0.5;
  }

  .image-with-fallback__text {
    font-family: 'Inter Variable', 'Inter', sans-serif;
    font-size: 0.875rem;
    color: #64748b;
    line-height: 1.5;
    margin: 0;
    font-weight: 500;
  }

  /* Loading skeleton animation */
  @keyframes shimmer {
    0% {
      background-position: -1000px 0;
    }
    100% {
      background-position: 1000px 0;
    }
  }

  .image-with-fallback__img:not(.loaded) {
    background: linear-gradient(
      90deg,
      #f1f5f9 0%,
      #e2e8f0 50%,
      #f1f5f9 100%
    );
    background-size: 1000px 100%;
    animation: shimmer 2s infinite;
  }

  @media (max-width: 768px) {
    .image-with-fallback__icon {
      width: 48px;
      height: 48px;
    }

    .image-with-fallback__text {
      font-size: 0.75rem;
    }

    .image-with-fallback__placeholder-content {
      padding: 1rem;
    }
  }
</style>
