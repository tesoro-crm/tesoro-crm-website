---
import Layout from '../../layouts/Layout.astro';
import ImageWithFallback from '../../components/blog/ImageWithFallback.astro';
import Button from '../../components/ui/Button.astro';
import { getCollection } from 'astro:content';
import { getLocale, getLocalizedPath } from '../../i18n/utils';
import type { Language } from '../../types/blog';
import { getAuthor } from '../../utils/authors';

const posts = await getCollection('blog', ({ data }) => !data.meta.draft);
const locale: Language = (getLocale(Astro.currentLocale, Astro.url) as Language) || 'nl';

// Sort posts by date (newest first)
const sortedPosts = posts.sort((a, b) => {
  const dateA = (a.data.meta as any).publishDate || (a.data.hero as any).publishDate;
  const dateB = (b.data.meta as any).publishDate || (b.data.hero as any).publishDate;
  return new Date(dateB).getTime() - new Date(dateA).getTime();
});

// Get featured post (most recent)
const featuredPost = sortedPosts[0];

// Get remaining posts for grid
const gridPosts = sortedPosts.slice(1);

// Get categories
const categories = [...new Set(posts.map(post => post.data.meta.category))];

// Pagination
const currentPage = parseInt(Astro.url.searchParams.get('page') || '1');
const postsPerPage = 9;
const totalPages = Math.ceil(gridPosts.length / postsPerPage);
const paginatedPosts = gridPosts.slice(
  (currentPage - 1) * postsPerPage,
  currentPage * postsPerPage
);

// Localized texts
const pageTitle = locale === 'nl' ? 'Tesoro CRM Blog' : locale === 'es' ? 'Blog de Tesoro CRM' : 'Tesoro CRM Blog';
const pageDescription = locale === 'nl'
  ? 'Ontdek de laatste inzichten over CRM, vastgoedmarketing en bedrijfsgroei.'
  : locale === 'es'
  ? 'Descubre las últimas perspectivas sobre CRM, marketing inmobiliario y crecimiento empresarial.'
  : 'Discover the latest insights on CRM, real estate marketing, and business growth.';
const latestText = locale === 'nl' ? 'Laatste' : locale === 'es' ? 'Último' : 'Latest';
const allPostsText = locale === 'nl' ? 'Alle Artikelen' : locale === 'es' ? 'Todos los Artículos' : 'All Articles';
const categoriesText = locale === 'nl' ? 'Categorieën' : locale === 'es' ? 'Categorías' : 'Categories';
const readMoreText = locale === 'nl' ? 'Lees meer' : locale === 'es' ? 'Leer más' : 'Read more';
---

<Layout
  title={pageTitle}
  description={pageDescription}
>
  <!-- Magazine Style Blog -->
  <div class="magazine">
    <!-- Header Section -->
    <header class="magazine__header">
      <div class="magazine__container">
        <h1 class="magazine__title">Blog</h1>
        <p class="magazine__subtitle">{pageDescription}</p>
      </div>
    </header>

    <!-- Featured Hero Post -->
    {featuredPost && (() => {
      const postData = featuredPost.data;
      const title = postData.hero.title[locale];
      const description = postData.hero.description[locale];
      const heroImage = postData.hero.image;
      const publishDateString = (postData.meta as any).publishDate || (postData.hero as any).publishDate;
      const publishDate = new Date(publishDateString);
      const authorId = (postData.meta as any).authorId || (postData.meta as any).author?.id || 'maria-perez';
      const author = getAuthor(authorId);

      return (
        <section class="magazine__featured">
          <div class="magazine__container">
            <span class="magazine__label">{latestText}</span>
            <a href={getLocalizedPath(`/blog/${postData.meta.id}`, locale)} class="magazine__featured-link">
              <article class="magazine__featured-card">
                <div class="magazine__featured-image">
                  <ImageWithFallback
                    src={heroImage.src}
                    alt={heroImage.alt[locale]}
                    width={1200}
                    height={600}
                    loading="eager"
                    class="magazine__featured-img"
                    aspectRatio="2/1"
                    clickable={false}
                  />
                </div>
                <div class="magazine__featured-content">
                  <span class="magazine__category magazine__category--large">{postData.meta.category}</span>
                  <h2 class="magazine__featured-title">{title}</h2>
                  <p class="magazine__featured-description">{description}</p>
                  <div class="magazine__featured-meta">
                    {author && (
                      <div class="magazine__author">
                        <ImageWithFallback
                          src={author.image}
                          alt={author.name}
                          width={48}
                          height={48}
                          loading="eager"
                          class="magazine__author-avatar"
                          aspectRatio="1/1"
                          clickable={false}
                        />
                        <div class="magazine__author-info">
                          <span class="magazine__author-name">{author.name}</span>
                          <time class="magazine__date" datetime={publishDateString}>
                            {publishDate.toLocaleDateString(locale === 'nl' ? 'nl-NL' : locale === 'es' ? 'es-ES' : 'en-US', {
                              month: 'long',
                              day: 'numeric',
                              year: 'numeric'
                            })}
                          </time>
                        </div>
                      </div>
                    )}
                  </div>
                </div>
              </article>
            </a>
          </div>
        </section>
      );
    })()}

    <!-- Main Content Grid -->
    <section class="magazine__main">
      <div class="magazine__container magazine__container--grid">
        <!-- Posts Grid -->
        <div class="magazine__posts">
          <div class="magazine__posts-header">
            <h2 class="magazine__section-title">{allPostsText}</h2>

            <!-- Category Filters -->
            <div class="magazine__filters">
              <a
                href={getLocalizedPath('/blog', locale)}
                class={`magazine__filter ${!Astro.url.searchParams.get('category') ? 'magazine__filter--active' : ''}`}
              >
                {allPostsText}
              </a>
              {categories.map(category => (
                <a
                  href={getLocalizedPath(`/blog?category=${encodeURIComponent(category)}`, locale)}
                  class={`magazine__filter ${Astro.url.searchParams.get('category') === category ? 'magazine__filter--active' : ''}`}
                >
                  {category}
                </a>
              ))}
            </div>
          </div>

          <!-- Posts Grid -->
          <div class="magazine__grid">
            {paginatedPosts.map((post, index) => {
              const postData = post.data;
              const title = postData.hero.title[locale];
              const description = postData.hero.description[locale];
              const heroImage = postData.hero.image;
              const publishDateString = (postData.meta as any).publishDate || (postData.hero as any).publishDate;
              const publishDate = new Date(publishDateString);
              const authorId = (postData.meta as any).authorId || (postData.meta as any).author?.id || 'maria-perez';
              const author = getAuthor(authorId);

              return (
                <article class={`magazine__card ${index === 0 ? 'magazine__card--large' : ''}`}>
                  <a href={getLocalizedPath(`/blog/${postData.meta.id}`, locale)} class="magazine__card-link">
                    <div class="magazine__card-image">
                      <ImageWithFallback
                        src={heroImage.src}
                        alt={heroImage.alt[locale]}
                        width={600}
                        height={400}
                        loading="lazy"
                        class="magazine__card-img"
                        aspectRatio="3/2"
                        clickable={false}
                      />
                      <span class="magazine__category magazine__category--overlay">{postData.meta.category}</span>
                    </div>
                    <div class="magazine__card-content">
                      <h3 class="magazine__card-title">{title}</h3>
                      <p class="magazine__card-description">{description}</p>
                      <div class="magazine__card-footer">
                        {author && (
                          <div class="magazine__card-author">
                            <ImageWithFallback
                              src={author.image}
                              alt={author.name}
                              width={32}
                              height={32}
                              loading="lazy"
                              class="magazine__card-avatar"
                              aspectRatio="1/1"
                              clickable={false}
                            />
                            <span class="magazine__card-author-name">{author.name}</span>
                          </div>
                        )}
                        <time class="magazine__card-date" datetime={publishDateString}>
                          {publishDate.toLocaleDateString(locale === 'nl' ? 'nl-NL' : locale === 'es' ? 'es-ES' : 'en-US', {
                            month: 'short',
                            day: 'numeric',
                            year: 'numeric'
                          })}
                        </time>
                      </div>
                    </div>
                  </a>
                </article>
              );
            })}
          </div>

          <!-- Pagination -->
          {totalPages > 1 && (
            <nav class="magazine__pagination">
              {currentPage > 1 && (
                <Button
                  href={getLocalizedPath(`/blog?page=${currentPage - 1}${Astro.url.searchParams.get('category') ? `&category=${Astro.url.searchParams.get('category')}` : ''}`, locale)}
                  variant="outline"
                  size="md"
                >
                  ← {locale === 'nl' ? 'Vorige' : locale === 'es' ? 'Anterior' : 'Previous'}
                </Button>
              )}
              <span class="magazine__pagination-info">
                {locale === 'nl' ? 'Pagina' : locale === 'es' ? 'Página' : 'Page'} {currentPage} {locale === 'nl' ? 'van' : locale === 'es' ? 'de' : 'of'} {totalPages}
              </span>
              {currentPage < totalPages && (
                <Button
                  href={getLocalizedPath(`/blog?page=${currentPage + 1}${Astro.url.searchParams.get('category') ? `&category=${Astro.url.searchParams.get('category')}` : ''}`, locale)}
                  variant="outline"
                  size="md"
                >
                  {locale === 'nl' ? 'Volgende' : locale === 'es' ? 'Siguiente' : 'Next'} →
                </Button>
              )}
            </nav>
          )}
        </div>

        <!-- Sidebar -->
        <aside class="magazine__sidebar">
          <!-- Categories Widget -->
          <div class="magazine__widget">
            <h3 class="magazine__widget-title">{categoriesText}</h3>
            <ul class="magazine__widget-list">
              <li>
                <a
                  href={getLocalizedPath('/blog', locale)}
                  class="magazine__widget-link"
                >
                  {allPostsText}
                </a>
              </li>
              {categories.map(category => (
                <li>
                  <a
                    href={getLocalizedPath(`/blog?category=${encodeURIComponent(category)}`, locale)}
                    class="magazine__widget-link"
                  >
                    {category}
                  </a>
                </li>
              ))}
            </ul>
          </div>

          <!-- Newsletter Widget -->
          <div class="magazine__widget magazine__widget--highlight">
            <h3 class="magazine__widget-title">Newsletter</h3>
            <p class="magazine__widget-text">
              {locale === 'nl'
                ? 'Ontvang de laatste blog posts in je inbox.'
                : locale === 'es'
                ? 'Recibe los últimos artículos en tu correo.'
                : 'Get the latest blog posts in your inbox.'}
            </p>
            <form class="magazine__newsletter-form">
              <input
                type="email"
                placeholder={locale === 'nl' ? 'Je email' : locale === 'es' ? 'Tu correo' : 'Your email'}
                class="magazine__newsletter-input"
                required
              />
              <Button type="submit" variant="white" size="md" fullWidth>
                {locale === 'nl' ? 'Abonneren' : locale === 'es' ? 'Suscribirse' : 'Subscribe'}
              </Button>
            </form>
          </div>
        </aside>
      </div>
    </section>
  </div>
</Layout>

<style>
  /* Magazine Layout */
  .magazine {
    min-height: 100vh;
    background: #f8f9fa;
  }

  .magazine__container {
    max-width: 1400px;
    margin: 0 auto;
    padding: 0 2rem;
  }

  .magazine__container--grid {
    display: grid;
    grid-template-columns: 1fr 320px;
    gap: 4rem;
    align-items: start;
  }

  /* Header */
  .magazine__header {
    background: white;
    border-bottom: 1px solid #e5e7eb;
    padding: 4rem 0 3rem;
  }

  .magazine__title {
    font-family: var(--font-heading);
    font-size: 4rem;
    font-weight: 800;
    color: #111827;
    margin: 0 0 1rem;
    letter-spacing: -0.03em;
  }

  .magazine__subtitle {
    font-size: 1.25rem;
    color: #6b7280;
    margin: 0;
    max-width: 600px;
  }

  /* Featured Post */
  .magazine__featured {
    background: white;
    padding: 3rem 0;
    border-bottom: 1px solid #e5e7eb;
  }

  .magazine__label {
    display: inline-block;
    font-size: 0.875rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: #ef4444;
    margin-bottom: 2rem;
  }

  .magazine__featured-link {
    text-decoration: none;
    color: inherit;
  }

  .magazine__featured-card {
    display: grid;
    grid-template-columns: 1.5fr 1fr;
    gap: 3rem;
    align-items: center;
  }

  .magazine__featured-image {
    position: relative;
    border-radius: 16px;
    overflow: hidden;
    aspect-ratio: 16 / 10;
  }

  .magazine__featured-img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: transform 0.3s ease;
  }

  .magazine__featured-link:hover .magazine__featured-img {
    transform: scale(1.05);
  }

  .magazine__featured-content {
    padding: 1rem 0;
  }

  .magazine__category {
    display: inline-block;
    font-size: 0.875rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: white;
    background: #111827;
    padding: 0.5rem 1rem;
    border-radius: 4px;
    margin-bottom: 1.5rem;
  }

  .magazine__category--large {
    font-size: 0.9375rem;
    padding: 0.625rem 1.25rem;
  }

  .magazine__category--overlay {
    position: absolute;
    top: 1rem;
    left: 1rem;
    z-index: 10;
  }

  .magazine__featured-title {
    font-family: var(--font-heading);
    font-size: 2.5rem;
    font-weight: 700;
    color: #111827;
    line-height: 1.2;
    margin: 0 0 1rem;
    letter-spacing: -0.02em;
  }

  .magazine__featured-description {
    font-size: 1.125rem;
    color: #4b5563;
    line-height: 1.6;
    margin: 0 0 2rem;
  }

  .magazine__featured-meta {
    display: flex;
    align-items: center;
    gap: 1.5rem;
  }

  .magazine__author {
    display: flex;
    align-items: center;
    gap: 1rem;
  }

  .magazine__author-avatar {
    width: 48px;
    height: 48px;
    border-radius: 50%;
    object-fit: cover;
  }

  .magazine__author-info {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
  }

  .magazine__author-name {
    font-weight: 600;
    color: #111827;
    font-size: 1rem;
  }

  .magazine__date {
    font-size: 0.875rem;
    color: #6b7280;
  }

  /* Main Content */
  .magazine__main {
    padding: 4rem 0 6rem;
  }

  .magazine__posts {
    min-width: 0;
  }

  .magazine__posts-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 3rem;
  }

  .magazine__section-title {
    font-family: var(--font-heading);
    font-size: 2rem;
    font-weight: 700;
    color: #111827;
    margin: 0;
  }

  /* Filters */
  .magazine__filters {
    display: flex;
    gap: 0.75rem;
    flex-wrap: wrap;
  }

  .magazine__filter {
    padding: 0.625rem 1.25rem;
    border-radius: 8px;
    font-size: 0.9375rem;
    font-weight: 500;
    text-decoration: none;
    color: #4b5563;
    background: white;
    border: 1px solid #e5e7eb;
    transition: all 0.2s ease;
  }

  .magazine__filter:hover {
    background: #f3f4f6;
    border-color: #d1d5db;
  }

  .magazine__filter--active {
    background: #111827;
    color: white;
    border-color: #111827;
  }

  /* Posts Grid */
  .magazine__grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 2rem;
  }

  .magazine__card {
    background: white;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    transition: transform 0.2s ease, box-shadow 0.2s ease;
  }

  .magazine__card:hover {
    transform: translateY(-4px);
    box-shadow: 0 12px 24px rgba(0, 0, 0, 0.15);
  }

  .magazine__card--large {
    grid-column: span 2;
    grid-row: span 2;
  }

  .magazine__card--large .magazine__card-content {
    padding: 2rem;
  }

  .magazine__card--large .magazine__card-title {
    font-size: 1.75rem;
  }

  .magazine__card--large .magazine__card-description {
    display: block;
  }

  .magazine__card-link {
    text-decoration: none;
    color: inherit;
    display: block;
  }

  .magazine__card-image {
    position: relative;
    aspect-ratio: 3 / 2;
    overflow: hidden;
  }

  .magazine__card-img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: transform 0.3s ease;
  }

  .magazine__card:hover .magazine__card-img {
    transform: scale(1.1);
  }

  .magazine__card-content {
    padding: 1.5rem;
  }

  .magazine__card-title {
    font-family: var(--font-heading);
    font-size: 1.25rem;
    font-weight: 600;
    color: #111827;
    line-height: 1.3;
    margin: 0 0 0.75rem;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  .magazine__card-description {
    display: none;
    font-size: 1rem;
    color: #6b7280;
    line-height: 1.6;
    margin: 0 0 1.5rem;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  .magazine__card-footer {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding-top: 1rem;
    border-top: 1px solid #f3f4f6;
  }

  .magazine__card-author {
    display: flex;
    align-items: center;
    gap: 0.75rem;
  }

  .magazine__card-avatar {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    object-fit: cover;
  }

  .magazine__card-author-name {
    font-size: 0.875rem;
    font-weight: 500;
    color: #111827;
  }

  .magazine__card-date {
    font-size: 0.875rem;
    color: #9ca3af;
  }

  /* Sidebar */
  .magazine__sidebar {
    position: sticky;
    top: 2rem;
  }

  .magazine__widget {
    background: white;
    border-radius: 12px;
    padding: 2rem;
    margin-bottom: 2rem;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
  }

  .magazine__widget--highlight {
    background: #111827;
    color: white;
  }

  .magazine__widget-title {
    font-family: var(--font-heading);
    font-size: 1.25rem;
    font-weight: 700;
    margin: 0 0 1.5rem;
  }

  .magazine__widget--highlight .magazine__widget-title {
    color: white;
  }

  .magazine__widget-list {
    list-style: none;
    padding: 0;
    margin: 0;
  }

  .magazine__widget-list li {
    border-bottom: 1px solid #f3f4f6;
  }

  .magazine__widget-list li:last-child {
    border-bottom: none;
  }

  .magazine__widget-link {
    display: block;
    padding: 0.875rem 0;
    font-size: 0.9375rem;
    font-weight: 500;
    color: #4b5563;
    text-decoration: none;
    transition: color 0.2s ease;
  }

  .magazine__widget-link:hover {
    color: #111827;
  }

  .magazine__widget-text {
    font-size: 0.9375rem;
    line-height: 1.6;
    margin: 0 0 1.5rem;
    opacity: 0.9;
  }

  .magazine__newsletter-form {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
  }

  .magazine__newsletter-input {
    padding: 0.875rem 1rem;
    border: 1px solid #374151;
    border-radius: 8px;
    font-size: 0.9375rem;
    background: #1f2937;
    color: white;
  }

  .magazine__newsletter-input::placeholder {
    color: #9ca3af;
  }

  .magazine__newsletter-input:focus {
    outline: none;
    border-color: white;
  }

  /* Pagination */
  .magazine__pagination {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 2rem;
    margin-top: 4rem;
    padding-top: 3rem;
    border-top: 1px solid #e5e7eb;
  }

  .magazine__pagination-info {
    font-size: 0.9375rem;
    color: #6b7280;
    font-weight: 500;
  }

  /* Responsive */
  @media (max-width: 1200px) {
    .magazine__container--grid {
      grid-template-columns: 1fr;
      gap: 3rem;
    }

    .magazine__sidebar {
      position: static;
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 2rem;
    }
  }

  @media (max-width: 1024px) {
    .magazine__grid {
      grid-template-columns: repeat(2, 1fr);
    }

    .magazine__card--large {
      grid-column: span 2;
      grid-row: span 1;
    }

    .magazine__featured-card {
      grid-template-columns: 1fr;
      gap: 2rem;
    }
  }

  @media (max-width: 768px) {
    .magazine__title {
      font-size: 2.5rem;
    }

    .magazine__subtitle {
      font-size: 1.125rem;
    }

    .magazine__header {
      padding: 3rem 0 2rem;
    }

    .magazine__container {
      padding: 0 1.5rem;
    }

    .magazine__posts-header {
      flex-direction: column;
      align-items: flex-start;
      gap: 1.5rem;
    }

    .magazine__grid {
      grid-template-columns: 1fr;
    }

    .magazine__card--large {
      grid-column: span 1;
    }

    .magazine__sidebar {
      grid-template-columns: 1fr;
    }

    .magazine__featured-title {
      font-size: 1.75rem;
    }

    .magazine__featured-description {
      font-size: 1rem;
    }
  }
</style>
